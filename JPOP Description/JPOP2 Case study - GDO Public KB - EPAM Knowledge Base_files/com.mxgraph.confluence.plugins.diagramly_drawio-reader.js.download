WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'com.mxgraph.confluence.plugins.diagramly:drawio-reader', location = 'js/mxViewer.js' */
var gOpenCommentsFn=null;function gOpenCommentsFunc(){if(gOpenCommentsFn!=null){gOpenCommentsFn()}}function createViewer(g,d){if(g==null){return}$deferred=$.Deferred();var q=g.parentNode;if(q!=null&&q.previousSibling!=null&&q.getAttribute("data-macro-name")=="drawio"&&q.previousSibling.nodeName=="P"&&(q.previousSibling.childNodes.length==0||q.previousSibling.innerHTML==" ")){q.previousSibling.appendChild(g)}function v(e){g.innerHTML=mxResources.get("error")+": "+e;g.style.height="24px"}function s(i,e){var C=document.createElement("div");C.style.position="absolute";C.style.overflow="hidden";C.style.left="0px";C.style.top="0px";C.style.right="0px";C.style.fontSize="14px";C.style.margin="2px";mxUtils.setOpacity(C,50);C.style.color="gray";C.style.textAlign="center";C.style.whiteSpace="nowrap";span=document.createElement("span");span.innerHTML=i;C.appendChild(span);e.appendChild(C);return C}function l(i){var e=null;if(window.mxResourcesLoaded&&mxResources.get("drawio.reader.evaluation")!=null){if(d.licenseStatus=="NO_LICENSE"){e=s(mxResources.get("drawio.reader.noLicense"),i)}else{if(d.licenseStatus=="EVAL_LICENSE"){e=s(mxResources.get("drawio.reader.evaluation"),i)}else{if(d.licenseStatus=="EVAL_EXPIRED"){e=s(mxResources.get("drawio.reader.evaluationExpired"),i)}else{if(d.licenseStatus=="VERSION_MISMATCH"){e=s(mxResources.get("drawio.reader.versionMismatch",["https://support.draw.io/pages/viewpage.action?pageId=11829320"]),i)}else{if(d.licenseStatus=="USER_MISMATCH"){e=s(mxResources.get("drawio.reader.userMismatch",["https://support.draw.io/pages/viewpage.action?pageId=11829323"]),i)}}}}}}return e}function b(e,C){var i=document.createElement("div");i.style.cssText=((C)?"position:absolute;top:50%;left:50%;margin-left:-20px;margin-top:-20px;":"position:relative;")+"width:40px;height:40px;";e.appendChild(i);new Spinner({lines:12,length:7,width:3,radius:6,rotate:0,color:"#000",speed:2,trail:60,shadow:false,hwaccel:false,className:"spinner",zIndex:999}).spin(i);return i}function r(D){var C={};try{C=JSON.parse(D)}catch(E){try{mxUtils.parseXml(D);C.xml=D;C.revision="";var i=d.loadUrl.match(/\/([^/]+)$/);C.name=i.length>=2?decodeURIComponent(i[1]):""}catch(E){}}return C}function n(D,e){if(D!=null){var i=D.openLink;D.openLink=function(G,H){var E=window;if(G.substring(0,this.baseUrl.length)==this.baseUrl&&G.charAt(this.baseUrl.length)=="#"&&H=="_top"&&window==window.top){var F=document.createElement("a");F.href="#"+MXGRAPH.resolvePageTargetName(e,G.split("#")[1]);F.style.display="none";g.appendChild(F);F.click();F.parentNode.removeChild(F)}else{if(G.lastIndexOf("/lightbox.action")!=-1){E=i.apply(this,[G,"_blank"])}else{E=i.apply(this,arguments)}}return E};var C=D.customLinkClicked;D.customLinkClicked=function(F){if(F.substring(0,16)=="data:scrollPage,"){try{var I=JSON.parse(atob(F.substring(16)));var E=window.open();E.document.writeln(mxResources.get("connecting")+"...");var G=AJS.Confluence.getContextPath();$.ajax({url:G+"/rest/api/content/"+AJS.Confluence.getContentId(),type:"GET",success:function(L){var J=L.space.key;var K=G+"/display/"+J+"/"+encodeURIComponent(I.confTitle.replace(/\s/g,"+"));$.ajax({url:K,type:"GET",success:function(M){E.location=K},error:function(M){$.ajax({url:G+"/rest/api/content/"+I.confId,type:"GET",success:function(N){E.location=G+"/display/"+J+"/"+encodeURIComponent(N.title.replace(/\s/g,"+"))},error:function(N){E.document.writeln(mxResources.get("pageNotFound"))}})}})},error:function(){E.document.writeln(mxResources.get("pageNotFound"))}});return true}catch(H){throw new Error("Unexpected Error")}}else{return C.apply(this,arguments)}}}}function A(i,e){if(i==null||e==null){return}$(i).parents().each(function(C,D){if($(D).data("macro-name")=="ui-expand"){e["check-visible-state"]=false}})}try{var k=d.contextPath;editUrl=d.editUrl;var u=8;GraphViewer.initCss();if(!window.mxResourcesLoaded&&d.language!=null){window.mxResourcesLoaded=true;var B=d.language;if(mxResources.isLanguageSupported(B)){mxClient.language=B}mxUtils.getAll([mxResources.getSpecialBundle(RESOURCE_BASE,mxClient.language)||mxResources.getDefaultBundle(RESOURCE_BASE,mxClient.language),d.resourcePath+((B=="de")?"_de":"")+".txt"],function(C){for(var e=0;e<C.length;e++){mxResources.parse(C[e].getText())}});var a=document.head.getElementsByTagName("link");var y=null;for(var w=0;w<a.length;w++){var m=a[w];if(m.getAttribute("type")==="text/css"&&m.getAttribute("rel")==="stylesheet"&&(/.*\/styles\/custom\.css\?spaceKey=.*$/.test(m.getAttribute("href")))){y=m.outerHTML;break}}if(y!=null){var p=PrintDialog.createPrintPreview;PrintDialog.createPrintPreview=function(){var i=p.apply(this,arguments);var e=i.writeHead;i.writeHead=function(C){e.apply(this,arguments);if(y!=null){C.writeln(y)}};return i}}}var z=Graph.prototype.getAbsoluteUrl;Graph.prototype.getAbsoluteUrl=function(e){if(e!=null&&e.charAt(0)=="/"&&e.substring(0,k.length)!==k){e=k+e}return z.apply(this,arguments)};GraphViewer.prototype.toolbarZIndex=1;var o=GraphViewer.prototype.getImageUrl;var f=/^(\.\.\/)*(\.\.)?\/download\//;var c=/.*com.mxgraph.confluence.plugins.diagramly:(drawio|diagramly)-editor/;GraphViewer.prototype.getImageUrl=function(e){if(e!=null&&e.substring(0,4)=="img/"){if(e.indexOf(".svg")!=-1){return SVGLOADER_URL+"?url="+encodeURIComponent(e)}return ATLAS_RESOURCE_BASE+"/"+e}else{if(e!=null&&e.substring(0,5)=="/img/"){return ATLAS_RESOURCE_BASE+e}else{if(e!=null&&f.test(e)){return k+e.substring(e.indexOf("/download/"))}else{if(e!=null&&e.substring(0,10)!="data:image"&&c.test(e)){return ATLAS_RESOURCE_BASE+e.replace(c,"")}else{return o.apply(this,arguments)}}}}};var t=GraphViewer.prototype.addClickHandler;GraphViewer.prototype.addClickHandler=function(C,i){var e=mxUtils.bind(this,function(){var D=C.container.getElementsByTagName("img");if(D!=null){for(var E=0;E<D.length;E++){D[E].setAttribute("src",this.getImageUrl(D[E].getAttribute("src")))}}});C.model.addListener(mxEvent.CHANGE,e);e();t.apply(this,arguments)};if(d.width!=null){g.style.width=d.width+"px"}function j(e){var i=b(g);mxUtils.get(d.loadUrl,mxUtils.bind(this,function(G){i.parentNode.removeChild(i);g.style.minHeight="";if(G.getStatus()<200||G.getStatus()>299){v(G.getStatus())}else{mxStencilRegistry.dynamicLoading=true;l(g);var F=r(G.getText());var H=mxUtils.parseXml(F.xml);if(d.border){g.style.border="1px solid #d0d0d0"}var D={"toolbar-position":d.tbstyle,nav:true,highlight:"#3b73af",border:u};if(d.links!="auto"){D.target=d.links}if(d.tbstyle=="top"){D.title=(d.diagramDisplayName!=null&&d.diagramDisplayName.length>0?d.diagramDisplayName:F.name)+" ["+F.revision+"]"}if(!d.lightbox){D.lightbox=false}if(d.tbstyle=="hidden"){D.resize=true}else{D.toolbar="edit pages zoom layers";if(d.lightbox){D.toolbar+=" lightbox"}}if(d.width!=null){D["allow-zoom-in"]=true}var C=null;viewer=null;D["toolbar-buttons"]={edit:{title:mxResources.get("edit"),enabled:d.editable,image:MXGRAPH.editImage,handler:function(J){if(d.editUrl.lastIndexOf("page-id")==-1){d.editUrl=d.editUrl+"&page="+viewer.currentPage}MXGRAPH.openEditor(d.editUrl,J.srcElement);MXGRAPH.viewerContainer=g;MXGRAPH.readerOpts=d}}};if(d.aspect!=null&&d.aspect.length>0){pageAndLayers=d.aspect.split(" ");D.layerIds=pageAndLayers.length>1?pageAndLayers.slice(1):null;pageId=pageAndLayers[0];d.editUrl+="&page-id="+pageId;diagrams=H.documentElement.getElementsByTagName("diagram");if(diagrams!=null){for(var E=0;E<diagrams.length;E++){if(diagrams[E].getAttribute("id")==pageId){D.page=E;break}}}}A(g,D);viewer=new GraphViewer(g,H.documentElement,D);n(viewer.graph,d.ceoName);MXGRAPH.overrideCellTooltips(viewer.graph,d.ceoName);MXGRAPH.addCommentsIcon(viewer,g,F.attachmentId);function I(){if(C!=null){C.window.setVisible(!C.window.isVisible())}else{EditorUi.prototype.createUi=function(){};EditorUi.prototype.addTrees=function(){};EditorUi.prototype.updateActionStates=function(){};EditorUi.prototype.installNativeClipboardHandler=function(){};EditorUi.prototype.createKeyHandler=function(){var L=new mxKeyHandler(this.editor.graph);L.bindAction=function(){};return L};var J=new EditorUi(new Editor(false,null,null,null,false));J.editor.attachmentInfo={attachmentId:F.attachmentId,revision:d.attVer};J.canComment=function(){return d.canComment};C=new CommentsWindow(J,document.body.offsetWidth-380,120,300,350);C.window.setVisible(true);var K=C.window.getElement();K.style.position="fixed"}C.window.getElement().style.zIndex=2000}EditorUi.prototype.lightboxToolbarActions=[{icon:Editor.commentImageInverted,tooltip:mxResources.get("comments"),fn:gOpenCommentsFunc}];if(viewer.graph==null||viewer.graph.model==null){return}viewer.showLocalLightbox=function(J){gOpenCommentsFn=I;var L=GraphViewer.prototype.showLocalLightbox.apply(this,arguments);n(L.editor.graph,d.ceoName);var K=L.destroy;L.destroy=function(){if(C!=null){C.window.setVisible(false)}K.apply(this,arguments)};if(J){I()}return L};EditorUi.prototype.hasUnresolvedComments(d.attId,function(J){if(J){img=document.getElementById("comments-icon-"+d.attId);img.style.display="inline"}},function(){});e.resolve(viewer)}}),function(){i.parentNode.removeChild(i);g.style.minHeight="";v(req.getStatus())})}if(d.simpleViewer){var h=document.createElement("img");h.setAttribute("src",d.imageUrl);h.setAttribute("border","0");h.style.cssText="width:100%;box-sizing:border-box;padding:"+u+"px;";if(d.border){h.style.border="1px solid #d0d0d0"}g.appendChild(h);if(d.lightbox){h.style.cursor="pointer";mxEvent.addListener(h,"click",function(){var e=b(g,true);mxUtils.get(d.loadUrl,function(C){e.parentNode.removeChild(e);if(C.getStatus()>=200&&C.getStatus()<=299){var i=r(C.getText());var D=mxUtils.parseXml(i.xml);var E=new GraphViewer(null,D.documentElement,{highlight:"#3b73af",nav:true,lightbox:false,toolbar:"pages zoom layers","check-visible-state":false});n(E.showLocalLightbox().editor.graph,d.ceoName)}},function(){e.parentNode.removeChild(e)})})}}else{g.style.minHeight="200px";j($deferred)}}catch(x){v(x.message)}return $deferred.promise()}MXGRAPH.addCommentsIcon=function(d,b,c){var a=document.createElement("img");a.style.cssText="position:absolute;bottom: 5px; right: 5px;opacity: 0.25; cursor: pointer;display : none";a.id="comments-icon-"+c;a.setAttribute("title",mxResources.get("showComments"));a.src=Editor.commentImage;a.addEventListener("click",mxUtils.bind(this,function(){d.showLocalLightbox(true)}));b.appendChild(a)};function updateDrawioViewer(b,c,a){viewerConfig=$(this).data("viewerConfig");if(c==viewerConfig.diagramName){$(this).empty();viewerConfig.editUrl=viewerConfig.editUrl.replace(/revision=\d+/,"revision="+a);viewerConfig.loadUrl=viewerConfig.loadUrl.replace(/revision=\d+/,"revision="+a);createViewer(this,viewerConfig)}}MXGRAPH.openEditor=function(c,b){var a=$('<iframe id="drawioEditor" >');a.appendTo("body");a.css({position:"fixed",width:"100%",height:"100%",top:"0px",left:"0px","border-style":"none",zIndex:1000});a.attr("src",c);MXGRAPH.editorFrame=a;MXGRAPH.editImgEl=b;b.src=window.IMAGE_PATH+"/spin.gif";b.width=21;b.height=21};MXGRAPH.closeEditor=function(){MXGRAPH.editorFrame.remove();MXGRAPH.editorFrame=null;MXGRAPH.viewerContainer=null;MXGRAPH.readerOpts=null;document.body.style.overflow="auto";MXGRAPH.editImgEl.src=MXGRAPH.editImage};MXGRAPH.postSave=function(a,e,c,b){$(".geDiagramContainer").trigger("drawioViewerUpdate",[e,c]);var d=new mxXmlRequest(AJS.Confluence.getContextPath()+"/rest/drawio/1.0/content/updateMacros/"+a+"/"+encodeURIComponent(e)+"/"+c+"?diagramWidth="+b,"","POST");d.setRequestHeaders=function(f,g){f.setRequestHeader("X-Atlassian-Token","no-check")};d.send(function(f){},function(f){console.log("There was a problem updating the drawio macro")})};MXGRAPH.overrideCellTooltips=function(b,a){if(b!=null){oldF=b.getTooltipForCell;b.getTooltipForCell=function(c){var d=oldF.apply(this,arguments);if(c.value!=null&&c.value.getAttribute!=null&&c.value.getAttribute("tooltip")!=null){return d}else{return d==null?null:MXGRAPH.resolvePageTargetName(a,d)}}}};MXGRAPH.editImage="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAVBAMAAABbObilAAAAD1BMVEUAAAAAAAAQEBBycnIgICBqwj3hAAAAAXRSTlMAQObYZgAAADlJREFUCNdjoBwoChrAmCyGggJwYWVBBSiTSVDICKFa0AEuLCiEJKyAX5gBSZgBSZgBKGwMBKQ7HAAWzQSfKKAyBgAAAABJRU5ErkJggg==";if(urlParams.dev=="1"){var mxDevUrl=document.location.protocol+"//devhost.jgraph.com/mxgraph2";var drawDevUrl=document.location.protocol+"//devhost.jgraph.com/drawio/src/main/webapp/";geBasePath=mxDevUrl+"/javascript/examples/grapheditor/www/js";mxBasePath=mxDevUrl+"/javascript/src";mxscript(drawDevUrl+"js/diagramly/Init.js");mxscript(geBasePath+"/Init.js");mxscript(mxBasePath+"/js/mxClient.js");mxscript(drawDevUrl+"js/diagramly/Devel.js");mxscript(drawDevUrl+"js/diagramly/GraphViewer.js");mxscript(drawDevUrl+"/connect/common/js/mxReader.js")};
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.mxgraph.confluence.plugins.diagramly:drawio-reader', location = 'js/DrawioComments.js' */
(function(){var e=null;var d="$$RES$$ ";var c="$$PREV_VER$$";var f='{"'+c+'": [';var b="]}";var a=window.DrawioProperties!=null?DrawioProperties.contextPath:AJS.Confluence.getContextPath();EditorUi.prototype.getCurrentUser=function(){if(e==null){$.ajax({url:a+"/rest/api/user/current",type:"GET",success:function(g){e=new DrawioUser(g.userKey,g.username,g.displayName,g.profilePicture.path)},error:function(g){},dataType:"json"});return new DrawioUser(Date.now(),null,"Anonymous")}return e};EditorUi.prototype.commentsSupported=function(){return true};EditorUi.prototype.canReplyToReplies=function(){return false};EditorUi.prototype.toDrawioComment=function(q,g,j,m){var k=j.history.createdBy;var n=new DrawioComment({id:q,ver:g,ui:this},j.id,decodeURIComponent(j.body.storage.value),j.version.when,j.history.createdDate,false,new DrawioUser(k.userKey,k.username,k.displayName,k.profilePicture.path));n.parentId=m;n.version=j.version.number;var o=j.children!=null?j.children.comment.results:[];for(var l=0;l<o.length;l++){var h=this.toDrawioComment(q,g,o[l],j.id);n.addReplyDirect(h);var p=h.content.indexOf(d)==0;if(p){h.content=h.content.substr(d.length);n.isResolved=l==(o.length-1)}}return n};EditorUi.prototype.getPrevVersionsComment=function(i,j,h){var g=this.editor.attachmentInfo.attachmentId;$.ajax({url:a+"/rest/api/content/"+g+"/child/comment?limit=200&expand=body.storage&parentVersion="+i,type:"GET",success:mxUtils.bind(this,function(p){p=p.results;var n=p.length;var k=[];for(var m=0;m<p.length;m++){var l=decodeURIComponent(p[m].body.storage.value);if(l.indexOf(f)==0){n--;try{k=JSON.parse(l)[c]}catch(o){}}}if(n>0){k.push(i)}j(k.length==0?null:this.newComment(f+k.join(",")+b,e))}),error:h,dataType:"json"})};EditorUi.prototype.getComments=function(n,j,m){var k=[];var g=1;function l(o){if(Array.isArray(o)){Array.prototype.push.apply(k,o)}g--;if(g==0){n(k)}}var i=this.editor.attachmentInfo;if(i&&i.attachmentId){var h=i.attachmentId;$.ajax({url:a+"/rest/api/content/"+h+"/child/comment?limit=200&expand=body.storage,version,history,children.comment.body.storage,children.comment.version,children.comment.history"+(m!=null?"&parentVersion="+m:""),type:"GET",success:mxUtils.bind(this,function(s){s=s.results;var o=[];for(var q=0;q<s.length;q++){var p=decodeURIComponent(s[q].body.storage.value);if(p.indexOf(f)==0){if(m==null){try{o=JSON.parse(p)[c];g+=o.length}catch(r){}}continue}var t=this.toDrawioComment(h,m||i.revision,s[q]);k.push(t)}l();for(var q=0;q<o.length;q++){this.getComments(l,l,o[q])}}),error:j,dataType:"json"})}else{j({message:mxResources.get("saveDiagramFirst",null,"Save diagram first!")})}};EditorUi.prototype.hasUnresolvedComments=function(i,m,j,l){function h(o){if(o.children!=null){var n=o.children.comment.results.pop();if(n!=null&&decodeURIComponent(n.body.storage.value).indexOf(d)==0){return true}else{return false}}else{return false}}var g=1;function k(n){g--;if(g==0){m(n||false)}}$.ajax({url:a+"/rest/api/content/"+i+"/child/comment?limit=200&expand=body.storage,version,history,children.comment.body.storage,children.comment.version,children.comment.history"+(l!=null?"&parentVersion="+l:""),type:"GET",success:function(r){r=r.results;var n=[];for(var p=0;p<r.length;p++){var o=decodeURIComponent(r[p].body.storage.value);if(o.indexOf(f)==0){if(l==null){try{n=JSON.parse(o)[c];g+=n.length}catch(q){}}continue}if(!h(r[p])){m(true);return}}k();for(var p=0;p<n.length;p++){EditorUi.prototype.hasUnresolvedComments(i,k,k,n[p])}},error:j,dataType:"json"})};EditorUi.prototype.addComment=function(k,j,i){var h=this.editor.attachmentInfo;if(h&&h.attachmentId){var g=h.attachmentId;$.ajax({url:a+"/rest/api/content",type:"POST",data:JSON.stringify({type:"comment",container:{type:"attachment",id:g},body:{storage:{value:encodeURIComponent(k.content),representation:"storage"}}}),success:function(l){k.version=l.version.number;j(l.id)},error:i,dataType:"json",contentType:"application/json"})}else{i({message:mxResources.get("saveDiagramFirst",null,"Save diagram first!")})}};EditorUi.prototype.newComment=function(i,h){var g=this.editor.attachmentInfo||{};return new DrawioComment({id:g.attachmentId,ver:g.revision,ui:this},null,i,Date.now(),Date.now(),false,h)};EditorUi.prototype.canComment=function(){return true};DrawioComment.prototype.addReply=function(k,s,o,t,j){var m=null;var q=this.file.id;var h=this.file.ver;var l=this.id;var r=this.file.ui;function g(u,v){$.ajax({url:a+"/rest/files/1.0/files/"+q+"/comments/"+l+"?attachmentVersion="+h,type:"PUT",data:JSON.stringify({resolved:u}),success:v,error:o,dataType:"json",contentType:"application/json"})}function n(u){if(r.editor.attachmentInfo.revision!=h){i(u);return}$.ajax({url:a+"/rest/api/content",type:"POST",data:JSON.stringify({type:"comment",ancestors:[{id:l}],container:{type:"attachment",id:q},body:{storage:{value:encodeURIComponent((t?d:"")+k.content),representation:"storage"}}}),success:function(v){k.version=v.version.number;m=v.id;u()},error:function(v){if(v.responseText.indexOf("messageKey=parent.comment.does.not.exist")>0){o({message:mxResources.get("parentCommentDel",null,"Parent comment has been deleted. A reply cannot be added.")})}else{o(v)}},dataType:"json",contentType:"application/json"})}function i(u){$.ajax({url:a+"/rest/files/1.0/files/"+q+"/comments?attachmentVersion="+h,type:"POST",data:JSON.stringify({parentId:l,commentBody:encodeURIComponent((t?d:"")+k.content)}),success:function(v){k.version=v.version.number;k.file.ver=h;m=v.id;u()},error:function(v){if(v.status==404){o({message:mxResources.get("parentCommentDel",null,"Parent comment has been deleted. A reply cannot be added.")})}else{o(v)}},dataType:"json",contentType:"application/json"})}var p=null;if(t){n(function(){g(true,function(){s(m)})})}else{if(j){g(false,function(){n(function(){s(m)})})}else{n(function(){s(m)})}}};DrawioComment.prototype.editComment=function(g,i,h){this.content=g;$.ajax({url:a+"/rest/api/content/"+this.id,type:"PUT",data:JSON.stringify({type:"comment",body:{storage:{value:encodeURIComponent(g),representation:"storage"}},container:{type:"attachment",id:this.file.id},version:{number:this.version+1}}),success:mxUtils.bind(this,function(j){this.version=j.version.number;i()}),error:h,dataType:"json",contentType:"application/json"})};DrawioComment.prototype.deleteComment=function(m,k){function h(n,i){$.ajax({url:a+"/rest/api/content/"+n,type:"DELETE",success:i,error:k,dataType:"json"})}var g=this.replies!=null?this.replies.length:0;var j=mxUtils.bind(this,function(){g--;if(g==0){h(this.id,m)}});if(g==0){h(this.id,m)}else{for(var l=0;l<g;l++){h(this.replies[l].id,j)}}};EditorUi.prototype.getCurrentUser()})();
}catch(e){WRMCB(e)};